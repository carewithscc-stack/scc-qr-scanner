<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SCC QR Scanner</title>

  <script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>

  <style>
    body {
      font-family: Arial, Helvetica, sans-serif;
      padding: 12px;
    }
    #reader {
      width: 100%;
      max-width: 500px;
      margin-top: 20px;
    }
    select, button {
      padding: 10px 14px;
      margin-top: 10px;
      font-size: 16px;
    }
    #log {
      margin-top: 20px;
      font-size: 14px;
      white-space: pre-wrap;
      background: #f5f5f5;
      padding: 10px;
    }
  </style>
</head>

<body>
  <h2>SCC QR Scanner</h2>

  <label for="action">Pilih aksi:</label>
  <select id="action">
    <option value="Picked Up">Picked Up</option>
    <option value="Start Work">Start Work</option>
    <option value="Finish Work">Finish Work</option>
    <option value="Delivered">Delivered</option>
  </select>

  <br>

  <button id="startBtn">Start Camera</button>
  <button id="stopBtn">Stop Camera</button>

  <div id="reader"></div>

  <div id="log"></div>

  <script>
    let scanner = null;
    const logBox = document.getElementById("log");

    function log(t) {
      const ts = new Date().toLocaleTimeString();
      logBox.textContent = `[${ts}] ${t}\n` + logBox.textContent;
    }

    document.getElementById("startBtn").onclick = async () => {
      try {
        const cameras = await Html5Qrcode.getCameras();
        if (!cameras.length) return log("No cameras found.");

        scanner = new Html5Qrcode("reader");

        await scanner.start(
          cameras[0].id,
          { fps: 10, qrbox: 250 },
          async (decodedText) => {
            const action = document.getElementById("action").value;
            log(`Scanned: ${decodedText}, Action: ${action}`);

            // === POST KE APPS SCRIPT ===
            fetch("https://script.google.com/macros/s/AKfycbwRSTGLtEI54Y5HxiZlDqSQbcO8VITtAj7susY-H6GWY3GOJubwEkDWNfpp4IOGzsoO/exec", {
              method: "POST",
              body: JSON.stringify({
                code: decodedText,
                action: action
              }),
              headers: { "Content-Type": "application/json" }
            })
              .then(r => r.text())
              .then(res => log("Response: " + res))
              .catch(err => log("POST Error: " + err));
          }
        );

        log("Camera started.");
      } catch (e) {
        log("Start error: " + e);
      }
    };

    document.getElementById("stopBtn").onclick = () => {
      if (!scanner) return;
      scanner.stop()
        .then(() => {
          scanner.clear();
          log("Camera stopped.");
        })
        .catch(err => log("Stop error: " + err));
    };
  </script>

</body>
</html>
