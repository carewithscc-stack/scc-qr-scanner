<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>SCC QR Scanner - Desain iOS/App Native</title>
<!-- Menggunakan CDN Tailwind untuk kelas utilitas dan estetika modern -->
<script src="https://cdn.tailwindcss.com"></script>
<style>
  /* Menetapkan font default yang mirip iOS dan styling dasar */
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
  :root { font-family: 'Inter', sans-serif; }
  /* Gaya full-screen app-like */
  body {
    display: flex;
    justify-content: center;
    align-items: flex-start; 
    min-height: 100vh;
    background-color: #f0f4f8;
    padding: 0; /* Hapus padding default */
  }
  /* Gaya App Container (seperti layar iPhone) */
  .card {
    background: #ffffff;
    padding: 0; /* Padding akan diberikan di dalam elemen anak */
    width: 100%;
    max-width: 480px; /* Batasan lebar seperti ponsel */
    min-height: 100vh; /* Ambil seluruh tinggi viewport */
    border-radius: 0; /* Hilangkan border-radius agar terlihat seamless dengan body */
    box-shadow: none; /* Hilangkan shadow di mode full-screen */
    display: flex;
    flex-direction: column;
  }
  
  /* Header dengan padding ala status bar mobile */
  .app-header {
    background-color: #ffffff;
    padding: 1.5rem 1rem 0.75rem 1rem;
    border-bottom: 1px solid #f0f4f8;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
  }
  
  h1 { 
    color: #1e293b; 
    font-size: 1.25rem; /* Lebih kecil dan elegan */
    font-weight: 600; 
    text-align: center; 
    margin-bottom: 0.5rem; 
  }

  /* Konten utama */
  .app-content {
    padding: 1rem;
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  /* Gaya elemen kontrol */
  select, input, button {
    font-size: 1rem; /* Ukuran sentuh lebih besar */
    padding: 0.75rem 1rem;
    border-radius: 0.75rem; /* Rounded corners lebih halus */
    transition: all 0.2s;
    border: 1px solid #e5e7eb;
    background-color: #f9fafb;
    width: 100%;
  }

  /* Gaya Tombol Aksi */
  button {
    cursor: pointer;
    border: none;
    background-color: #007aff; /* Warna primer iOS Blue */
    color: #fff;
    font-weight: 600;
    box-shadow: 0 2px 4px rgba(0, 122, 255, 0.3); /* Shadow iOS-like */
  }
  button:hover:not(:disabled) { 
    background-color: #0056b3; 
    box-shadow: 0 1px 2px rgba(0, 122, 255, 0.5); 
    transform: none; /* iOS doesn't typically translate */
  }
  button:active:not(:disabled) { 
    background-color: #004c99; 
    transform: translateY(1px); /* Efek sentuhan */
  }
  button:disabled { 
    background-color: #cbd5e1; 
    color: #71717a; 
    cursor: not-allowed; 
    box-shadow: none;
  }
  
  /* Grup tombol agar tetap rapi */
  .controls-group {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }
  .controls-group .flex-grow {
    flex-grow: 1;
  }

  label { font-size: 0.875rem; font-weight: 500; color: #475569; margin-bottom: 0.25rem; }
  
  /* Area Pemindai */
  #reader {
    width: 100%;
    height: 350px; /* Lebih tinggi untuk fokus scanning */
    background: #000;
    border-radius: 1rem;
    overflow: hidden;
    border: 5px solid #007aff; /* Border biru iOS */
    margin-bottom: 1rem;
  }

  /* Gaya Status */
  .status {
    padding: 0.75rem 1rem;
    border-radius: 0.75rem;
    font-weight: 600;
    margin-bottom: 0.75rem;
    border: none; /* Hilangkan border, hanya pakai warna background */
  }
  .status.loading { background-color: #ffcc0044; color: #8e6a00; }
  .status.success { background-color: #34c75944; color: #006000; }
  .status.error { background-color: #ff3b3044; color: #8e0000; }
  
  /* Area Log */
  .log {
    background-color: #f8fafc;
    padding: 1rem;
    border-radius: 0.75rem;
    font-family: monospace;
    font-size: 0.75rem;
    max-height: 150px;
    overflow-y: auto;
    border: 1px solid #e2e8f0;
    white-space: pre-wrap;
  }
</style>
</head>
<body>
<div class="card">
<div class="app-header">
  <h1>SCC QR Scanner — Resilient Mode</h1>
</div>

<div class="app-content">

  <!-- Bagian Pemindaian dan Status -->
  <div id="reader"></div>
  <div id="statusLine" class="status loading">Menunggu library...</div>
  
  <!-- Kontrol Utama (Pilih Aksi) -->
  <label class="flex flex-col">Aksi / Status Baru:
    <select id="action">
      <option>Picked Up</option>
      <option>Start Work</option>
      <option>Finish Work</option>
      <option>Delivered</option>
    </select>
  </label>

  <!-- Kontrol Kamera -->
  <label class="flex flex-col">Kamera:
    <select id="cameraSelect"><option value="">-- memuat --</option></select>
  </label>

  <!-- Grup Tombol Aksi -->
  <div class="controls-group mt-2">
    <button id="permBtn" class="bg-gray-400 hover:bg-gray-500">Cek Izin Kamera</button>
    <div class="flex gap-2">
      <button id="startBtn" disabled class="flex-grow">Mulai Pemindaian</button>
      <button id="stopBtn" disabled class="flex-grow bg-red-500 hover:bg-red-600 shadow-none">Berhenti</button>
    </div>
  </div>

  <!-- Debug & Fallback (Sekarang diaktifkan kembali) -->
  <button id="loadLocalBtn" class="bg-gray-500 hover:bg-gray-700 mt-4 text-xs">Muat Library Lokal (Fallback)</button>
  <div class="log" id="logArea"></div>
</div>

</div>

<script>
/* ================= SCC QR Scanner — Versi Optimal ================= */

// URL CDN library html5-qrcode
const CDNS = ["https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.7/minified/html5-qrcode.min.js"];

// ***********************************************************************************
// URL WEB APP DEPLOYMENT GOOGLE APPS SCRIPT (Harus diganti dengan URL deployment Anda)
const GAS_URL = 'https://script.google.com/macros/s/AKfycbz5rW4yJLEm2bEv92-hQSEH06sxgA93dhGnhAzRR2cIM0mB6rTN3pBXwGf3hfbSplc1/exec'; 
// ***********************************************************************************

let scanner = null;
let isScanning = false;

/**
 * Fungsi untuk mencatat pesan ke area log dan konsol.
 */
const LOG = (s, l = 'i') => {
    const el = document.getElementById('logArea');
    const now = new Date().toLocaleTimeString('id-ID');
    // Batasi jumlah log di UI agar tidak terlalu panjang
    const newLog = document.createElement('div');
    newLog.textContent = `${now} | ${s}`;
    el.prepend(newLog);
    if(el.children.length > 20) el.removeChild(el.lastChild);
    
    if (l === 'e') console.error(s);
    else console.log(s);
};

/**
 * Fungsi untuk memperbarui status di UI.
 */
const setStatus = (txt, type = 'loading') => {
    const el = document.getElementById('statusLine');
    el.textContent = txt;
    el.className = 'status ' + type;
    LOG('STATUS: ' + txt);
};

/**
 * Memuat skrip eksternal secara asinkron.
 */
function loadScript(src) {
    return new Promise((res, rej) => {
        const s = document.createElement('script');
        s.src = src;
        s.onload = res;
        s.onerror = rej;
        document.head.appendChild(s);
    });
}

/**
 * Mempersiapkan fungsionalitas memuat library dari file lokal (fallback).
 * Listener dipasang di sini, dan dipanggil saat inisialisasi utama.
 */
function attachLocalLoader() {
    const localBtn = document.getElementById('loadLocalBtn');
    if (localBtn) { 
        localBtn.addEventListener('click', () => {
            const f = document.createElement('input');
            f.type = 'file';
            f.accept = '.js';
            f.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const blob = URL.createObjectURL(file);
                try {
                    await loadScript(blob);
                    setStatus('Library dimuat (lokal)', 'success');
                    initAfterLib();
                } catch (err) {
                    setStatus('Gagal memuat lokal', 'error');
                    LOG('Gagal memuat library lokal: ' + err, 'e');
                }
            };
            f.click();
        });
    }
}

/**
 * Fungsi deduplikasi: mencegah pengiriman ganda dalam waktu singkat (5 detik).
 * Adaptasi: Mengatasi keterbatasan double scan/re-scan yang cepat.
 */
function dedupeCheck(code) {
    const now = Date.now();
    if (!window.recentScans) window.recentScans = new Map();
    const last = window.recentScans.get(code) || 0;

    // Batas deduplikasi: 5 detik
    if (now - last < 5000) return true;

    window.recentScans.set(code, now);

    // Hapus entri lama
    for (const [k, t] of window.recentScans) if (now - t > 60000) window.recentScans.delete(k);

    return false;
}

/**
 * Menangani keberhasilan pemindaian QR dan mengirim data ke Apps Script.
 */
function onScanSuccess(decodedText) {
    if (dedupeCheck(decodedText)) {
        LOG('Duplikat diabaikan: ' + decodedText);
        return;
    }

    LOG('QR Terdeteksi: ' + decodedText);

    const action = document.getElementById('action').value;
    const payload = JSON.stringify({ qr: decodedText, action: action });

    // Status Awal: Menunjukkan pengiriman sedang berlangsung
    setStatus('Mengirim data...', 'loading');

    // Mengirim data ke Apps Script menggunakan fetch dan mode 'no-cors'.
    // Ini mengasumsikan sukses jika tidak ada error jaringan, karena Apps Script akan memprosesnya.
    fetch(GAS_URL, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json' 
        },
        body: payload,
        mode: 'no-cors' 
    })
    .then(() => {
        // Asumsikan sukses
        setStatus(`Data terkirim: ${action} (${decodedText.substring(0, 10)}...)`, 'loading');

        // Tunda status sukses nyata untuk feedback visual yang lebih baik
        setTimeout(() => {
             setStatus(`Sukses! ${action} untuk ${decodedText.substring(0, 10)}.`, 'success');
        }, 2000); 

    })
    .catch(error => {
        // Ini hanya akan menangkap error jaringan murni (misalnya, tidak ada internet)
        setStatus('Gagal terhubung ke server (jaringan murni)', 'error');
        LOG('Error jaringan murni saat mengirim data: ' + error, 'e');
    });
}

/**
 * Memulai pemindai.
 */
async function startScanner(devId = null) {
    if (typeof Html5Qrcode === 'undefined') {
        setStatus('Library belum dimuat', 'error');
        return;
    }
    if (isScanning) return;

    // Prioritaskan kamera belakang/environment
    const cfg = devId && devId !== "" ? { deviceId: { exact: devId } } : { facingMode: "environment" };
    
    const config = {
        fps: 10,
        qrbox: { width: 280, height: 200 },
        disableFlip: false 
    };

    scanner = new Html5Qrcode("reader");
    setStatus('Memulai kamera...', 'loading');

    try {
        await scanner.start(cfg, config, onScanSuccess, (errMsg) => {
            // Abaikan error pemindaian minor
        });
        isScanning = true;
        document.getElementById('startBtn').disabled = true;
        document.getElementById('stopBtn').disabled = false;
        setStatus('Pemindai berjalan', 'success');
    } catch (e) {
        setStatus('Gagal memulai. Pastikan kamera dipilih dan diizinkan.', 'error');
        LOG('Gagal memulai pemindai: ' + e, 'e');
    }
}

/**
 * Menghentikan pemindai.
 */
async function stopScanner() {
    if (!isScanning || !scanner) return;
    try {
        await scanner.stop();
        scanner.clear();
    } catch (e) {
        LOG('Error saat menghentikan pemindai: ' + e, 'e');
    }
    scanner = null;
    isScanning = false;
    document.getElementById('startBtn').disabled = false;
    document.getElementById('stopBtn').disabled = true;
    setStatus('Pemindai dihentikan', 'loading');
    LOG('Pemindai dihentikan');
}

/**
 * Mendaftarkan kamera yang tersedia dan memilih kamera belakang sebagai default.
 */
async function listCameras() {
    const sel = document.getElementById('cameraSelect');
    sel.innerHTML = '<option value="">-- memuat --</option>'; 
    
    try {
        const cams = await Html5Qrcode.getCameras();
        sel.innerHTML = '';
        let environmentCameraId = null;

        cams.forEach((c, i) => {
            const o = document.createElement('option');
            o.value = c.id;
            o.textContent = c.label || `Kamera ${i + 1}`;
            sel.appendChild(o);
            
            // Logika untuk memilih kamera belakang (environment) sebagai default
            const labelLower = c.label.toLowerCase();
            if (labelLower.includes('back') || labelLower.includes('environment') || labelLower.includes('belakang')) {
                environmentCameraId = c.id;
            }
        });

        if (environmentCameraId) {
            sel.value = environmentCameraId;
            LOG('Kamera belakang otomatis terpilih.');
        } else if (cams.length > 0) {
            sel.value = cams[0].id;
        }

        document.getElementById('startBtn').disabled = false;

    } catch (e) {
        LOG('Gagal memuat daftar kamera. Periksa izin.', 'e');
        sel.innerHTML = '<option value="">(Error Kamera)</option>';
        document.getElementById('startBtn').disabled = true;
    }
}

/**
 * Meminta izin kamera dari browser.
 */
async function checkPermission() {
    try {
        // Meminta izin video
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        
        // Hentikan stream setelah mendapatkan izin
        stream.getTracks().forEach(track => track.stop()); 

        setStatus('Izin kamera diberikan', 'success');
        await listCameras();
    } catch (e) {
        setStatus('Izin kamera ditolak. Beri izin di pengaturan browser Anda.', 'error');
        LOG('Izin kamera ditolak: ' + e.name, 'e');
    }
}

/* ================= INISIALISASI DAN EVENT LISTENERS ================= */

// Event Listeners
document.getElementById('permBtn').addEventListener('click', () => checkPermission());
document.getElementById('startBtn').addEventListener('click', () => startScanner(document.getElementById('cameraSelect').value));
document.getElementById('stopBtn').addEventListener('click', () => stopScanner());
document.getElementById('cameraSelect').addEventListener('change', () => {
    if (isScanning) {
        // Otomatis restart scanner jika kamera diubah saat sedang berjalan
        stopScanner().then(() => startScanner(document.getElementById('cameraSelect').value));
    }
});

// Fungsi yang dijalankan setelah library html5-qrcode berhasil dimuat
async function initAfterLib() {
    await checkPermission(); 
}

// Inisialisasi: Coba muat library
(async () => {
    try {
        await loadScript(CDNS[0]);
        setStatus('Library dimuat (CDN)', 'success');
        initAfterLib();
    } catch (e) {
        let errMsg = e instanceof Event ? 'File CDN tidak dapat dimuat (kemungkinan masalah jaringan atau izin).' : e.toString();
        // Mengubah pesan status untuk mengarahkan pengguna ke tombol fallback yang kini aktif
        setStatus('CDN gagal. Coba "Muat Library Lokal" di bawah.', 'error'); 
        LOG('Gagal memuat CDN: ' + errMsg, 'e');
    }
    // PENTING: Attach listener untuk Local Loader terlepas dari keberhasilan CDN
    attachLocalLoader();
})();
</script>
</body>
</html>
