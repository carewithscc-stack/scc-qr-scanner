<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SCC QR Scanner</title>

  <!-- Stable CDN Html5 QR Code -->
  <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.7/minified/html5-qrcode.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    button {
      padding: 12px 20px;
      font-size: 16px;
      margin: 5px;
      border-radius: 10px;
      border: none;
      background: black;
      color: white;
      cursor: pointer;
    }
    select {
      padding: 10px;
      font-size: 16px;
      border-radius: 8px;
    }
    #reader {
      width: 350px;
      margin-top: 20px;
    }
  </style>
</head>
<body>

  <h2>SCC QR Scanner</h2>

  <label for="action">Pilih aksi:</label>
  <select id="action">
    <option value="Picked Up">Picked Up</option>
    <option value="Delivered">Delivered</option>
  </select>

  <br><br>

  <button id="startBtn">Start Camera</button>
  <button id="stopBtn">Stop Camera</button>

  <div id="reader"></div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      console.log("ðŸ”§ DOM ready, Html5Qrcode type:", typeof Html5Qrcode);

      if (typeof Html5Qrcode === "undefined") {
        alert("Html5Qrcode library belum dimuat! Coba refresh halaman.");
        return;
      }

      let scanner = null;

      const startBtn = document.getElementById("startBtn");
      const stopBtn = document.getElementById("stopBtn");

      startBtn.onclick = function () {
        if (scanner) {
          console.warn("Scanner sudah berjalan");
          return;
        }

        scanner = new Html5Qrcode("reader");
        console.log("â–¶ Starting scanner...");

        scanner.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: 250 },
          (decodedText) => {
            console.log("âœ… QR FOUND:", decodedText);

            // Kirim hasil ke Google Apps Script
            fetch(
              "https://script.google.com/macros/s/AKfycbwRSTGLtEI54Y5HxiZlDqSQbcO8VITtAj7susY-H6GWY3GOJubwEkDWNfpp4IOGzsoO/exec",
              {
                method: "POST",
                body: JSON.stringify({
                  qr: decodedText,
                  action: document.getElementById("action").value,
                }),
              }
            ).catch(err => console.error("Error sending to server:", err));

            alert("QR Scanned: " + decodedText);
          },
          (error) => {
            console.log("Scan error:", error);
          }
        ).catch(err => {
          console.error("Failed to start scanner:", err);
          scanner = null;
        });
      };

      stopBtn.onclick = function () {
        if (!scanner) {
          console.warn("Scanner belum berjalan");
          return;
        }

        scanner.stop().then(() => {
          console.log("â¹ Camera stopped");
          scanner.clear();
          scanner = null;
        }).catch(err => {
          console.error("Stop error:", err);
        });
      };
    });
  </script>

</body>
</html>
