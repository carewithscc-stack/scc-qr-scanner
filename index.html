<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SCC QR Scanner — Final Beauty Edition</title>
<style>
body{font-family:Arial,sans-serif;background:#f0f2f5;padding:20px;display:flex;justify-content:center;}
.card{background:#fff;border-radius:15px;box-shadow:0 8px 20px rgba(0,0,0,0.15);padding:20px;max-width:480px;width:100%;}
h1{text-align:center;color:#222;margin-bottom:15px;}
.controls{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-bottom:12px;}
select,input{padding:10px;border-radius:8px;border:1px solid #ccc;font-size:14px;}
button{padding:10px 18px;border:none;border-radius:10px;background:#111;color:#fff;font-weight:bold;cursor:pointer;transition:0.2s;}
button:hover{background:#333;}
button:disabled{opacity:0.5;cursor:not-allowed;}
#reader{width:100%;height:260px;background:#000;border-radius:12px;margin-bottom:12px;position:relative;overflow:hidden;}
.status{font-size:14px;margin-bottom:8px;padding:6px 10px;border-radius:8px;}
.status.loading{background:#fff8c6;color:#9a6f00;}
.status.success{background:#d4edda;color:#155724;}
.status.error{background:#f8d7da;color:#721c24;}
.small{font-size:12px;color:#555;margin-bottom:6px;display:flex;justify-content:space-between;}
.log{background:#f7f7f7;padding:10px;border-radius:10px;font-family:monospace;font-size:12px;max-height:160px;overflow-y:auto;border:1px solid #eee;}
</style>

<!-- Html5 QR Code CDN -->
<script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
</head>
<body>
<div class="card">
<h1>SCC QR Scanner — Final Beauty Edition</h1>

<div class="controls">
<label>Aksi:<br>
<select id="action">
<option>Order Received</option>
<option>Processing</option>
<option>Picked Up</option>
<option>In Transit</option>
<option>Delivered</option>
<option>Completed</option>
</select>
</label>

<label>Kamera:<br>
<select id="cameraSelect"><option>-- memuat --</option></select>
</label>

<button id="startBtn" disabled>Start</button>
<button id="stopBtn" disabled>Stop</button>
</div>

<div id="reader"></div>

<div id="statusLine" class="status loading">Menunggu scanner...</div>
<div class="small">
<span>Pending: <span id="pendingCount">0</span></span>
<span>Last Send: <span id="lastSend">-</span></span>
</div>

<label class="small">Server endpoint:</label>
<input id="endpoint" value="https://script.google.com/macros/s/AKfycbwRSTGLtEI54Y5HxiZlDqSQbcO8VITtAj7susY-H6GWY3GOJubwEkDWNfpp4IOGzsoO/exec" style="width:100%;padding:8px;border-radius:6px;margin-bottom:10px;">

<div class="log" id="logArea"></div>
</div>

<script>
const LOG=(s,l='i')=>{const el=document.getElementById('logArea');const now=(new Date()).toLocaleTimeString();el.textContent=`${now} ${s}\n`+el.textContent;if(l==='e')console.error(s);else console.log(s);};
const setStatus=(txt,type='loading')=>{const el=document.getElementById('statusLine');el.textContent=txt;el.className='status '+type;LOG('STATUS: '+txt);};

const QUEUE_KEY='scc_qr_queue_final';
function loadQueue(){try{return JSON.parse(localStorage.getItem(QUEUE_KEY)||'[]');}catch(e){return[];}}
function saveQueue(q){localStorage.setItem(QUEUE_KEY,JSON.stringify(q));document.getElementById('pendingCount').textContent=q.length;}
function pushQueue(item){const q=loadQueue();q.push(item);saveQueue(q);}
function shiftQueue(){const q=loadQueue();if(q.length===0)return null;const it=q.shift();saveQueue(q);return it;}

let retryTimer=null; let retryDelay=2000;
async function trySendNext(){const q=loadQueue();if(q.length===0){document.getElementById('pendingCount').textContent=0;return;}const item=q[0];try{setStatus('Sending to server...','loading');LOG('Sending: '+JSON.stringify(item));const res=await fetch(document.getElementById('endpoint').value,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(item),keepalive:true});if(res.ok){LOG('Server OK, removing from queue');shiftQueue();document.getElementById('lastSend').textContent=new Date().toLocaleString();retryDelay=2000;setTimeout(trySendNext,200);}else{LOG('Server error: '+res.status,'e');scheduleRetry();}}catch(err){LOG('Send failed: '+(err.message||err),'e');scheduleRetry();}}
function scheduleRetry(){if(retryTimer)return;const delay=Math.min(retryDelay,60000);LOG('Retry in '+delay/1000+'s');retryTimer=setTimeout(()=>{retryTimer=null;retryDelay=Math.min(retryDelay*1.8,60000);trySendNext();},delay);}
setInterval(()=>{trySendNext();},15000);

let scanner=null,isScanning=false;
const recentScans=new Map();
const DEDUPE_MS=5000;
function dedupeCheck(code){const now=Date.now();const last=recentScans.get(code)||0;if(now-last<DEDUPE_MS)return true;recentScans.set(code,now);for(const [k,t] of recentScans){if(now-t>60000)recentScans.delete(k);}return false;}

async function startScanner(deviceId=null){
  if(typeof window.Html5Qrcode==='undefined'){setStatus('Library not loaded','error');return;}
  if(isScanning){LOG('Scanner already running');return;}
  try{
    scanner=new Html5Qrcode("reader",{verbose:false});
    const cfg = deviceId ? { deviceId: { exact: deviceId } } : undefined;
    setStatus('Starting camera...','loading');
    await scanner.start(cfg,{fps:10,qrbox:{width:280,height:200}},onScanSuccess,onScanFailure);
    isScanning=true;
    document.getElementById('startBtn').disabled=true;
    document.getElementById('stopBtn').disabled=false;
    setStatus('Scanner running','success');
    LOG('Scanner started on deviceId: '+deviceId);
  }catch(err){
    LOG('Failed start: '+(err.message||err),'e');setStatus('Failed start: '+(err.message||err),'error');
    if(scanner){try{scanner.clear();}catch(e){}scanner=null;isScanning=false;}
  }
}

function onScanSuccess(decodedText,decodedResult){
  if(dedupeCheck(decodedText)){LOG('Duplicate scan ignored: '+decodedText);return;}
  LOG('QR detected: '+decodedText);
  const payload={qr:decodedText,action:document.getElementById('action').value,user:'Bos Alva',ts:(new Date()).toISOString()};
  pushQueue(payload);
  trySendNext();
  const r=document.getElementById('reader'); r.style.background='#0f0';
  setTimeout(()=>{r.style.background='#000';},200);
  const beep=new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA=');
  beep.play();
}

function onScanFailure(err){}

async function stopScanner(){
  if(!isScanning||!scanner){LOG('Stop requested but scanner not running');return;}
  try{await scanner.stop();}catch(e){LOG('Stop error: '+(e.message||e),'e');}
  try{scanner.clear();}catch(e){}
  scanner=null;isScanning=false;
  document.getElementById('startBtn').disabled=false;
  document.getElementById('stopBtn').disabled=true;
  setStatus('Scanner stopped','loading');
  LOG('Scanner stopped');
}

async function listCameras(){
  const select=document.getElementById('cameraSelect'); select.innerHTML='<option>memuat...</option>';
  try{
    const cams = await Html5Qrcode.getCameras();
    if(cams && cams.length){
      select.innerHTML='';
      cams.forEach((c,i)=>{
        const opt=document.createElement('option');
        opt.value=c.id;
        opt.textContent=c.label || `Camera ${i+1}`;
        select.appendChild(opt);
      });
      startScanner(cams[0].id);
    }else{select.innerHTML='<option>(no camera)</option>';}
  }catch(err){LOG('Camera list failed: '+(err.message||err),'e');select.innerHTML='<option>(camera error)</option>';}
}

document.getElementById('cameraSelect').addEventListener('change',()=>{const camId=document.getElementById('cameraSelect').value;if(isScanning){stopScanner().then(()=>startScanner(camId));}});
document.getElementById('startBtn').addEventListener('click',()=>{startScanner(document.getElementById('cameraSelect').value||null);});
document.getElementById('stopBtn').addEventListener('click',()=>stopScanner());

document.addEventListener('DOMContentLoaded',()=>{listCameras();document.getElementById('startBtn').disabled=false;setStatus('Ready','success');});
</script>
</body>
</html>
