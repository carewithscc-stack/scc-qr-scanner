<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SCC QR Scanner — Final</title>
<style>
  body{font-family:Arial,sans-serif;background:#f0f2f5;padding:20px;display:flex;justify-content:center;}
  .card{background:#fff;border-radius:15px;box-shadow:0 8px 20px rgba(0,0,0,0.15);padding:20px;width:420px;}
  h1{text-align:center;color:#222;margin-bottom:12px;font-size:22px;}
  .controls{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-bottom:15px;}
  select,input,button{font-size:14px;padding:10px;border-radius:8px;}
  button{cursor:pointer;border:none;background:#111;color:#fff;font-weight:bold;transition:.2s;}
  button:hover{background:#333;}
  #reader{width:100%;height:260px;background:#000;border-radius:12px;border:2px solid #444;margin-bottom:12px;}
  .status{padding:6px 10px;border-radius:8px;margin-bottom:8px;}
  .status.loading{background:#fff8c6;color:#9a6f00;}
  .status.success{background:#d4edda;color:#155724;}
  .status.error{background:#f8d7da;color:#721c24;}
  .log{background:#f7f7f7;padding:10px;border-radius:10px;font-family:monospace;font-size:12px;max-height:160px;overflow-y:auto;border:1px solid #eee;}
</style>
</head>
<body>
<div class="card">
<h1>SCC QR Scanner — Final</h1>

<div class="controls">
<label>Aksi:<br>
<select id="action">
  <option>Picked Up</option>
  <option>Start Work</option>
  <option>Finish Work</option>
  <option>Delivered</option>
</select>
</label>

<label>Kamera:<br>
<select id="cameraSelect"><option>-- memuat --</option></select>
</label>

<button id="permBtn">Check Camera</button>
<button id="startBtn" disabled>Start</button>
<button id="stopBtn" disabled>Stop</button>
<button id="loadLocalBtn">Load local JS</button>
</div>

<div id="reader"></div>
<div id="statusLine" class="status loading">Menunggu library...</div>
<div class="log" id="logArea"></div>
</div>

<script>
/* ================= SCC QR Scanner — Final ================= */
const LOG=(s,l='i')=>{const el=document.getElementById('logArea');const now=new Date().toLocaleTimeString();el.textContent=`${now} ${s}\n`+el.textContent;if(l==='e')console.error(s);else console.log(s);};
const setStatus=(txt,type='loading')=>{const el=document.getElementById('statusLine');el.textContent=txt;el.className='status '+type;LOG('STATUS: '+txt);};

const CDNS=["https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.7/minified/html5-qrcode.min.js"];
function loadScript(src){return new Promise((res,rej)=>{const s=document.createElement('script');s.src=src;s.onload=res;s.onerror=rej;document.head.appendChild(s);});}

function attachLocalLoader(){document.getElementById('loadLocalBtn').addEventListener('click',()=>{const f=document.createElement('input');f.type='file';f.accept='.js';f.onchange=async(e)=>{const file=e.target.files[0];if(!file)return;const blob=URL.createObjectURL(file);try{await loadScript(blob);setStatus('Library loaded (local)','success');initAfterLib();}catch(err){setStatus('Local load failed','error');LOG(err,'e');}};f.click();});}

let scanner=null,isScanning=false;
function dedupeCheck(code){const now=Date.now();if(!window.recentScans)window.recentScans=new Map();const last=window.recentScans.get(code)||0;if(now-last<5000)return true;window.recentScans.set(code,now);for(const [k,t] of window.recentScans)if(now-t>60000)window.recentScans.delete(k);return false;}
async function startScanner(devId=null){if(typeof Html5Qrcode==='undefined'){setStatus('Library not loaded','error');return;}if(isScanning)return;scanner=new Html5Qrcode("reader");const cfg=devId?{deviceId:{exact:devId}}:{facingMode:"environment"};setStatus('Starting camera...','loading');try{await scanner.start(cfg,{fps:10,qrbox:{width:280,height:200}},onScanSuccess,()=>{});isScanning=true;document.getElementById('startBtn').disabled=true;document.getElementById('stopBtn').disabled=false;setStatus('Scanner running','success');}catch(e){setStatus('Failed start','error');LOG(e,'e');}}

function onScanSuccess(decodedText){if(dedupeCheck(decodedText)){LOG('Duplicate ignored: '+decodedText);return;}LOG('QR: '+decodedText);fetch('https://script.google.com/macros/s/AKfycbyJvluaqqe3J_suB8RBWMptb51Iw7msr3R1KDB204w0XoBaZwlcahDZzJKaY90fiBcw/exec',{method:'POST',body:JSON.stringify({qr:decodedText,action:document.getElementById('action').value})});}

async function stopScanner(){if(!isScanning||!scanner)return;try{await scanner.stop();scanner.clear();}catch(e){}scanner=null;isScanning=false;document.getElementById('startBtn').disabled=false;document.getElementById('stopBtn').disabled=true;setStatus('Scanner stopped','loading');LOG('Scanner stopped');}

async function listCameras(){const sel=document.getElementById('cameraSelect');sel.innerHTML='<option>memuat...</option>';try{const cams=await Html5Qrcode.getCameras();sel.innerHTML='';cams.forEach((c,i)=>{const o=document.createElement('option');o.value=c.id;o.textContent=c.label||`Camera ${i+1}`;sel.appendChild(o);});}catch(e){LOG(e,'e');sel.innerHTML='<option>(camera error)</option>';}}
async function checkPermission(){try{await navigator.mediaDevices.getUserMedia({video:true});setStatus('Camera granted','success');await listCameras();document.getElementById('startBtn').disabled=false;}catch(e){setStatus('Camera denied','error');LOG(e,'e');}}

document.getElementById('permBtn').addEventListener('click',()=>checkPermission());
document.getElementById('startBtn').addEventListener('click',()=>startScanner(document.getElementById('cameraSelect').value));
document.getElementById('stopBtn').addEventListener('click',()=>stopScanner());
document.getElementById('cameraSelect').addEventListener('change',()=>{if(isScanning)stopScanner().then(()=>startScanner(document.getElementById('cameraSelect').value));});

async function initAfterLib(){await listCameras();document.getElementById('startBtn').disabled=false;}
(async()=>{try{await loadScript(CDNS[0]);setStatus('Library loaded (CDN)','success');initAfterLib();attachLocalLoader();}catch(e){setStatus('CDN failed — load local','error');LOG(e,'e');attachLocalLoader();}})();
</script>
</body>
</html>