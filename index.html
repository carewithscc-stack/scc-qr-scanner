<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SCC QR Scanner — Final Simplified</title>
<!-- Gaya diambil dari file referensi Anda, dengan penyesuaian kecil -->
<style>
    body { 
        font-family: Arial, sans-serif; 
        background: #f0f2f5; 
        padding: 20px; 
        display: flex; 
        justify-content: center; 
        min-height: 100vh;
        margin: 0;
    }
    .card { 
        background: #fff; 
        border-radius: 15px; 
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15); 
        padding: 20px; 
        width: 100%;
        max-width: 420px; /* Lebar maksimum seperti di referensi */
        box-sizing: border-box;
    }
    h1 { 
        text-align: center; 
        color: #222; 
        margin-bottom: 12px; 
        font-size: 24px; 
        font-weight: bold;
    }
    .controls { 
        display: flex; 
        flex-wrap: wrap; 
        gap: 10px; 
        justify-content: center; 
        margin-bottom: 15px; 
    }
    .action-group {
        display: flex;
        flex-direction: column;
        width: 100%;
    }
    .action-group select, .action-group button {
        width: 100%;
    }
    select, input, button { 
        font-size: 14px; 
        padding: 10px; 
        border-radius: 8px;
        box-sizing: border-box; 
        border: 1px solid #ccc;
        background: #f9f9f9;
    }
    button { 
        cursor: pointer; 
        border: none; 
        background: #007bff; /* Warna biru untuk tombol Start/Stop */
        color: #fff; 
        font-weight: bold; 
        transition: .2s; 
    }
    button:hover { 
        background: #0056b3; 
    }
    #reader { 
        width: 100%; 
        height: 260px; 
        background: #000; 
        border-radius: 12px; 
        border: 2px solid #444; 
        margin-bottom: 12px;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        text-align: center;
        font-size: 16px;
    }
    .status { 
        padding: 8px 12px; /* Disesuaikan agar sedikit lebih besar */
        border-radius: 8px; 
        margin-bottom: 12px; /* Disesuaikan */
        font-weight: bold;
    }
    .status.loading { 
        background: #fff8c6; 
        color: #9a6f00; 
    }
    .status.success { 
        background: #d4edda; 
        color: #155724; 
    }
    .status.error { 
        background: #f8d7da; 
        color: #721c24; 
    }
    .log { 
        background: #f7f7f7; 
        padding: 10px; 
        border-radius: 10px; 
        font-family: monospace; 
        font-size: 12px; 
        max-height: 160px; 
        overflow-y: auto; 
        border: 1px solid #eee; 
    }
    /* Gaya untuk Spanduk Peringatan HTTPS */
    #https-warning {
        background-color: #dc3545; /* Merah */
        color: white;
        padding: 15px;
        border-radius: 10px;
        text-align: center;
        font-weight: bold;
        margin-bottom: 20px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }
    .action-buttons-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        margin-top: 15px;
    }
    .action-buttons-grid button {
        background: #333;
    }
    .action-buttons-grid button.selected {
        background: #155724;
        border: 2px solid #d4edda;
    }
</style>
</head>
<body>
<div class="card">
    <!-- SPANDUK PERINGATAN HTTPS KRITIS -->
    <div id="https-warning" class="hidden">
        <p class="text-lg">‼️ PERINGATAN KRITIS ‼️</p>
        <p class="mt-1">AKSES KAMERA DIBLOKIR. Anda HARUS menggunakan URL HTTPS untuk mengaktifkan scanner.</p>
    </div>

    <h1>SCC QR Scanner</h1>

    <div class="controls">
        <div class="action-group">
            <label for="action" style="font-size: 14px; font-weight: bold; margin-bottom: 5px;">Aksi Terpilih:</label>
            <select id="action">
                <option value="Picked Up">Picked Up</option>
                <option value="Start Work">Start Work</option>
                <option value="Finish Work">Finish Work</option>
                <option value="Delivered">Delivered</option>
            </select>
        </div>
        
        <!-- Pilihan Kamera Dihapus untuk menyederhanakan -->

        <button id="startBtn">Mulai Pindai</button>
        <button id="stopBtn" disabled style="background:#dc3545;">Hentikan Pindai</button>
    </div>

    <div id="reader">Scanner nonaktif. Akses via HTTPS diperlukan.</div>
    <div id="statusLine" class="status loading">Menunggu inisialisasi...</div>
    <div class="log" id="logArea"></div>
</div>

<script>
/* ================= SCC QR Scanner — Simplified and Styled ================= */
// URL Apps Script dari referensi terbaru Anda
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyJvluaqqe3J_suB8RBWMptb51Iw7msr3R1KDB204w0XoBaZwlcahDZzJKaY90fiBcw/exec';
const HTML5_QRCODE_CDN = "https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.7/minified/html5-qrcode.min.js";

// Elemen UI
const logAreaEl = document.getElementById('logArea');
const statusLineEl = document.getElementById('statusLine');
const readerEl = document.getElementById('reader');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const actionSelect = document.getElementById('action');
const httpsWarningEl = document.getElementById('https-warning');

const DEBOUNCE_TIME_MS = 1500;
const DEDUPE_TIME_MS = 5000;

// --- UTILITY FUNCTIONS ---

const LOG = (s, l = 'i') => {
    const now = new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    const logEntry = document.createElement('div');
    logEntry.innerHTML = `[${now}] ${s}`;
    
    // Menampilkan log terbaru di atas
    if (logAreaEl.firstChild) {
        logAreaEl.insertBefore(logEntry, logAreaEl.firstChild);
    } else {
        logAreaEl.appendChild(logEntry);
    }
    // Batasi log
    while (logAreaEl.children.length > 30) {
        logAreaEl.removeChild(logAreaEl.lastChild);
    }

    if (l === 'e') console.error(s);
    else if (l === 'w') console.warn(s);
    else console.log(s);
};

const setStatus = (txt, type = 'loading') => {
    statusLineEl.textContent = txt;
    statusLineEl.className = 'status ' + type;
    LOG('STATUS: ' + txt, type === 'error' ? 'e' : (type === 'warning' ? 'w' : 'i'));
};

const loadScript = (src) => {
    return new Promise((res, rej) => {
        const s = document.createElement('script');
        s.src = src;
        s.onload = res;
        s.onerror = rej;
        document.head.appendChild(s);
    });
};

// --- SCANNER LOGIC ---

let scanner = null;
let isScanning = false;

function dedupeCheck(code) {
    const now = Date.now();
    if (!window.recentScans) window.recentScans = new Map();
    const last = window.recentScans.get(code) || 0;
    
    // Cek apakah scan duplikat dalam batas waktu DEDUPE_TIME_MS
    if (now - last < DEDUPE_TIME_MS) return true; 
    
    window.recentScans.set(code, now);
    
    // Bersihkan map dari entri yang sangat lama
    for (const [k, t] of window.recentScans) {
        if (now - t > 60000) window.recentScans.delete(k);
    }
    return false;
}

function setReaderPlaceholder(message) {
    // Memastikan placeholder ditampilkan dengan baik di area #reader
    readerEl.innerHTML = `<div style="padding: 10px;">${message}</div>`;
}

async function startScanner() {
    if (typeof Html5Qrcode === 'undefined') {
        setStatus('Library Html5Qrcode belum dimuat.', 'error');
        return;
    }

    // 1. Cek HTTPS
    if (location.protocol !== 'https:') {
        setStatus('❌ GAGAL: Aplikasi harus diakses via HTTPS untuk menggunakan kamera.', 'error');
        setReaderPlaceholder('GAGAL. Akses via HTTPS diperlukan.');
        return;
    }

    // 2. Hentikan jika sudah berjalan
    if (isScanning) {
        await stopScanner(false); // Hentikan tanpa set status akhir
    }
    
    scanner = new Html5Qrcode("reader");
    
    // 3. Konfigurasi untuk kamera belakang/environment
    const videoConstraints = {
        facingMode: "environment" // Prioritas kamera belakang
    };

    setStatus('Memulai kamera... (Mohon izinkan akses)', 'loading');
    startBtn.disabled = true;
    
    try {
        await scanner.start(
            videoConstraints,
            { fps: 10, qrbox: { width: 280, height: 200 } },
            onScanSuccess,
            (errorMessage) => {
                // Pesan error non-fatal (noise) bisa diabaikan
                if (isScanning) return;
                // Jika error saat start
                if(scanner && scanner.getState() !== 2) {
                    LOG("Gagal memulai kamera: " + errorMessage, 'e');
                    setStatus('❌ Gagal: Coba tekan "Mulai Pindai" atau cek izin.', 'error');
                    setReaderPlaceholder('GAGAL MEMULAI KAMERA. Cek izin browser.');
                    startBtn.disabled = false;
                }
            }
        );
        isScanning = true;
        stopBtn.disabled = false;
        setStatus('Scanner berjalan. Pilih aksi dan pindai QR.', 'success');
    } catch (e) {
        isScanning = false;
        startBtn.disabled = false;
        stopBtn.disabled = true;
        LOG("Gagal memulai atau izin ditolak: " + e.message, 'e');
        setStatus('❌ Error fatal: Izin ditolak atau gagal memulai. Pastikan Anda di HTTPS.', 'error');
        setReaderPlaceholder('IZIN DITOLAK. Klik "Mulai Pindai" untuk coba lagi.');
    }
}

async function stopScanner(setFinalStatus = true) {
    if (!isScanning || !scanner) return;
    setStatus('Menghentikan scanner...');
    try {
        await scanner.stop();
        scanner.clear();
    } catch (e) {
        LOG("Error saat menghentikan scanner: " + e.message, 'w');
    }
    scanner = null;
    isScanning = false;
    startBtn.disabled = false;
    stopBtn.disabled = true;
    if (setFinalStatus) {
        setStatus('Scanner dihentikan.', 'loading');
        setReaderPlaceholder('Scanner nonaktif. Tekan "Mulai Pindai".');
    }
}

function onScanSuccess(decodedText) {
    if (dedupeCheck(decodedText)) {
        LOG('QR Code diabaikan (Duplikasi): ' + decodedText, 'w');
        return;
    }

    const selectedAction = actionSelect.value;
    
    stopScanner(false).then(() => {
        setStatus(`QR Diterima: ${decodedText}. Mengirim aksi: ${selectedAction}...`, 'loading');
        sendDataToAppsScript(decodedText, selectedAction);
    });
}

// --- APPS SCRIPT COMMUNICATION ---

async function sendDataToAppsScript(qrCode, action) {
    const payload = { qr: qrCode, action: action };
    LOG('Mencoba mengirim data ke Apps Script...');

    try {
        for (let i = 0; i < 3; i++) {
            try {
                // Menggunakan fetch dengan no-cors untuk Apps Script
                await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                LOG(`Pengiriman sukses pada percobaan ke-${i + 1}.`);
                break; 
            } catch (e) {
                LOG(`Gagal kirim data (Percobaan ${i + 1}): ${e.message}`, 'w');
                if (i < 2) { 
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000)); 
                } else { 
                    throw e; 
                }
            }
        }
        setStatus(`✅ Sukses! Status '${action}' untuk OrderID '${qrCode}' telah diperbarui.`, 'success');
        
    } catch (error) {
        LOG('Error fatal saat koneksi/pengiriman: ' + error.message, 'e');
        setStatus(`❌ Error: ${error.message}. Gagal terhubung ke Apps Script.`, 'error');
    } finally {
        // Reset state dan mulai ulang scanner setelah delay
        setTimeout(() => {
            LOG('Memulai ulang scanner.');
            if (location.protocol === 'https:') {
                startScanner(); 
            }
        }, DEBOUNCE_TIME_MS); 
    }
}

// --- INITIALIZATION ---

function checkSecureContext() {
    if (location.protocol !== 'https:') {
        httpsWarningEl.classList.remove('hidden');
        setStatus('❌ PERINGATAN! Kamera diblokir. Akses via HTTPS diperlukan.', 'error');
        setReaderPlaceholder('AKSES KAMERA DIBLOKIR. Anda harus menggunakan HTTPS.');
        LOG('Aplikasi berjalan di HTTP. Akses kamera akan diblokir oleh browser.', 'e');
    } else {
        httpsWarningEl.classList.add('hidden');
        LOG('Koneksi aman (HTTPS). Lanjut memuat library.');
    }
}

async function init() {
    LOG('Aplikasi dimuat. Memulai inisialisasi.');
    checkSecureContext(); 

    // Muat library QR Code
    try {
        await loadScript(HTML5_QRCODE_CDN);
        setStatus('Library pemindaian dimuat.', 'loading');
        
        // Aktifkan tombol dan coba mulai scanner jika HTTPS
        startBtn.disabled = false;
        if (location.protocol === 'https:') {
            startScanner();
        } else {
            setStatus('Pilih aksi dan siapkan kamera (Akses via HTTPS).', 'info');
        }

    } catch (e) {
        setStatus('❌ GAGAL memuat library pemindaian.', 'error');
        LOG('Gagal memuat CDN Html5Qrcode: ' + e.message, 'e');
        startBtn.disabled = true;
    }
}

// Tambahkan event listeners
startBtn.addEventListener('click', startScanner);
stopBtn.addEventListener('click', () => stopScanner(true));

// Mulai
window.onload = init;
</script>
</body>
</html>
