<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>SCC QR Scanner - Versi Optimal</title>
<!-- Menggunakan CDN Tailwind untuk kelas utilitas dan estetika modern -->
<script src="https://cdn.tailwindcss.com"></script>
<style>
  /* Menetapkan font default */
  :root { font-family: 'Inter', sans-serif; }
  /* Gaya dasar untuk latar belakang dan centering */
  body {
    display: flex;
    justify-content: center;
    align-items: flex-start; /* Mulai dari atas agar lebih baik di ponsel */
    min-height: 100vh;
    background-color: #f0f4f8;
    padding: 1rem;
  }
  /* Gaya Card utama - responsif */
  .card {
    background: #ffffff;
    border-radius: 1.5rem;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    padding: 1.5rem;
    width: 100%;
    max-width: 480px; /* Batasi lebar maksimum */
  }
  h1 { color: #1e293b; font-size: 1.5rem; font-weight: 700; text-align: center; margin-bottom: 1rem; }
  .controls { display: flex; flex-wrap: wrap; gap: 0.75rem; justify-content: center; margin-bottom: 1rem; }
  /* Gaya elemen kontrol */
  select, input, button {
    font-size: 0.875rem;
    padding: 0.6rem 1rem;
    border-radius: 0.75rem;
    transition: all 0.2s;
    border: 1px solid #cbd5e1;
  }
  button {
    cursor: pointer;
    border: none;
    background-color: #3b82f6; /* Warna primer biru */
    color: #fff;
    font-weight: 600;
  }
  button:hover:not(:disabled) { background-color: #2563eb; transform: translateY(-1px); }
  button:disabled { background-color: #9ca3af; cursor: not-allowed; }
  label { font-size: 0.875rem; font-weight: 500; color: #475569; }
  /* Area Pemindai */
  #reader {
    width: 100%;
    height: 300px;
    background: #000;
    border-radius: 1rem;
    overflow: hidden;
    border: 4px solid #3b82f6;
    margin-bottom: 1rem;
  }
  /* Gaya Status */
  .status {
    padding: 0.75rem 1rem;
    border-radius: 0.75rem;
    margin-bottom: 0.75rem;
    font-weight: 600;
  }
  .status.loading { background-color: #fef3c7; color: #a16207; border: 1px solid #fcd34d; }
  .status.success { background-color: #dcfce7; color: #059669; border: 1px solid #34d399; }
  .status.error { background-color: #fee2e2; color: #dc2626; border: 1px solid #f87171; }
  /* Area Log */
  .log {
    background-color: #f8fafc;
    padding: 1rem;
    border-radius: 0.75rem;
    font-family: monospace;
    font-size: 0.75rem;
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #e2e8f0;
    white-space: pre-wrap; /* Pastikan teks log tidak menyebabkan scroll horizontal */
  }
</style>
</head>
<body>
<div class="card">
<h1>SCC QR Scanner — Versi Optimal</h1>

<div class="controls">
<label class="flex flex-col">Aksi:
<select id="action">
  <option>Picked Up</option>
  <option>Start Work</option>
  <option>Finish Work</option>
  <option>Delivered</option>
</select>
</label>

<label class="flex flex-col">Kamera:
<select id="cameraSelect"><option value="">-- memuat --</option></select>
</label>

<button id="permBtn" class="flex-grow">Cek Izin Kamera</button>
<button id="startBtn" disabled class="flex-grow">Mulai Pemindaian</button>
<button id="stopBtn" disabled class="flex-grow">Berhenti</button>
<button id="loadLocalBtn" class="bg-gray-500 hover:bg-gray-700">Muat Library Lokal</button>
</div>

<div id="reader"></div>
<div id="statusLine" class="status loading">Menunggu library...</div>
<div class="log" id="logArea"></div>
</div>

<script>
/* ================= SCC QR Scanner — Versi Optimal ================= */

// URL CDN library html5-qrcode
const CDNS = ["https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.7/minified/html5-qrcode.min.js"];
const GAS_URL = 'https://script.google.com/macros/s/AKfycbyJvluaqqe3J_suB8RBWMptb51Iw7msr3R1KDB204w0XoBaZwlcahDZzJKaY90fiBcw/exec';

let scanner = null;
let isScanning = false;

/**
 * Fungsi untuk mencatat pesan ke area log dan konsol.
 * @param {string} s - Pesan yang akan dicatat.
 * @param {string} l - Level log ('i' untuk info, 'e' untuk error).
 */
const LOG = (s, l = 'i') => {
    const el = document.getElementById('logArea');
    const now = new Date().toLocaleTimeString();
    // Tambahkan pesan baru di atas pesan lama
    el.textContent = `${now} ${s}\n` + el.textContent;
    if (l === 'e') console.error(s);
    else console.log(s);
};

/**
 * Fungsi untuk memperbarui status di UI.
 * @param {string} txt - Teks status.
 * @param {string} type - Tipe status ('loading', 'success', 'error').
 */
const setStatus = (txt, type = 'loading') => {
    const el = document.getElementById('statusLine');
    el.textContent = txt;
    el.className = 'status ' + type;
    LOG('STATUS: ' + txt);
};

/**
 * Memuat skrip eksternal secara asinkron.
 * @param {string} src - URL skrip.
 */
function loadScript(src) {
    return new Promise((res, rej) => {
        const s = document.createElement('script');
        s.src = src;
        s.onload = res;
        s.onerror = rej;
        document.head.appendChild(s);
    });
}

/**
 * Mempersiapkan fungsionalitas memuat library dari file lokal.
 */
function attachLocalLoader() {
    document.getElementById('loadLocalBtn').addEventListener('click', () => {
        const f = document.createElement('input');
        f.type = 'file';
        f.accept = '.js';
        f.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const blob = URL.createObjectURL(file);
            try {
                await loadScript(blob);
                setStatus('Library dimuat (lokal)', 'success');
                initAfterLib();
            } catch (err) {
                setStatus('Gagal memuat lokal', 'error');
                LOG('Gagal memuat library lokal: ' + err, 'e');
            }
        };
        f.click();
    });
}

/**
 * Fungsi deduplikasi: memeriksa apakah kode QR sudah dipindai dalam 5 detik terakhir.
 * @param {string} code - Kode QR yang dipindai.
 * @returns {boolean} True jika kode adalah duplikat.
 */
function dedupeCheck(code) {
    const now = Date.now();
    if (!window.recentScans) window.recentScans = new Map();
    const last = window.recentScans.get(code) || 0;

    // Batas deduplikasi: 5 detik
    if (now - last < 5000) return true;

    window.recentScans.set(code, now);

    // Hapus entri yang lebih dari 60 detik untuk menjaga Map tetap bersih
    for (const [k, t] of window.recentScans) if (now - t > 60000) window.recentScans.delete(k);

    return false;
}

/**
 * Menangani keberhasilan pemindaian QR.
 * @param {string} decodedText - Teks dari kode QR.
 */
function onScanSuccess(decodedText) {
    if (dedupeCheck(decodedText)) {
        LOG('Duplikat diabaikan: ' + decodedText);
        return;
    }

    LOG('QR Terdeteksi: ' + decodedText);

    // Kirim data ke Google Apps Script
    const action = document.getElementById('action').value;
    const payload = JSON.stringify({ qr: decodedText, action: action });

    fetch(GAS_URL, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json' // Tambahkan header Content-Type
        },
        body: payload
    })
    .then(response => {
        if (response.ok) {
            LOG(`Data berhasil dikirim: ${decodedText} (${action})`, 'success');
            // Jika Anda ingin membaca pesan sukses dari GAS, tambahkan:
            // return response.json().then(data => LOG('Respon GAS: ' + JSON.stringify(data))); 
        } else {
            LOG(`Gagal mengirim data (Status: ${response.status}): ${decodedText}`, 'e');
        }
    })
    .catch(error => {
        LOG('Error jaringan saat mengirim data: ' + error, 'e');
    });
}

/**
 * Memulai pemindai dengan ID perangkat tertentu.
 * @param {string | null} devId - ID perangkat kamera.
 */
async function startScanner(devId = null) {
    if (typeof Html5Qrcode === 'undefined') {
        setStatus('Library belum dimuat', 'error');
        return;
    }
    if (isScanning) return;

    // Gunakan konfigurasi 'deviceId' jika ID tersedia, jika tidak, coba 'environment'
    // Catatan: devId kosong ('') akan diatasi oleh listCameras yang memilih default ID
    const cfg = devId && devId !== "" ? { deviceId: { exact: devId } } : { facingMode: "environment" };
    
    // Konfigurasi pemindai: 10 FPS, kotak pemindaian 280x200
    const config = {
        fps: 10,
        qrbox: { width: 280, height: 200 },
        disableFlip: false 
    };

    scanner = new Html5Qrcode("reader");
    setStatus('Memulai kamera...', 'loading');

    try {
        // Coba mulai pemindaian
        await scanner.start(cfg, config, onScanSuccess, (errMsg) => {
            // function onScanError
        });
        isScanning = true;
        document.getElementById('startBtn').disabled = true;
        document.getElementById('stopBtn').disabled = false;
        setStatus('Pemindai berjalan', 'success');
    } catch (e) {
        setStatus('Gagal memulai. Pastikan kamera dipilih dan diizinkan.', 'error');
        LOG('Gagal memulai pemindai: ' + e, 'e');
    }
}

/**
 * Menghentikan pemindai.
 */
async function stopScanner() {
    if (!isScanning || !scanner) return;
    try {
        await scanner.stop();
        scanner.clear();
    } catch (e) {
        LOG('Error saat menghentikan pemindai: ' + e, 'e');
    }
    scanner = null;
    isScanning = false;
    document.getElementById('startBtn').disabled = false;
    document.getElementById('stopBtn').disabled = true;
    setStatus('Pemindai dihentikan', 'loading');
    LOG('Pemindai dihentikan');
}

/**
 * Mendaftarkan kamera yang tersedia dan memilih kamera belakang sebagai default.
 */
async function listCameras() {
    const sel = document.getElementById('cameraSelect');
    sel.innerHTML = '<option value="">-- memuat --</option>'; 
    
    try {
        const cams = await Html5Qrcode.getCameras();
        sel.innerHTML = '';
        let environmentCameraId = null;

        cams.forEach((c, i) => {
            const o = document.createElement('option');
            o.value = c.id;
            o.textContent = c.label || `Kamera ${i + 1}`;
            sel.appendChild(o);
            
            // LOGIKA OPTIMAL: Coba identifikasi kamera belakang (environment)
            const labelLower = c.label.toLowerCase();
            if (labelLower.includes('back') || labelLower.includes('environment') || labelLower.includes('belakang')) {
                environmentCameraId = c.id;
            }
        });

        // Tetapkan kamera belakang sebagai pilihan default jika ditemukan
        if (environmentCameraId) {
            sel.value = environmentCameraId;
            LOG('Kamera belakang otomatis terpilih sebagai default.');
        } else if (cams.length > 0) {
            // Jika kamera belakang tidak dapat diidentifikasi, pilih kamera pertama
            sel.value = cams[0].id;
        }

        document.getElementById('startBtn').disabled = false;

    } catch (e) {
        LOG('Gagal memuat daftar kamera. Periksa izin.', 'e');
        sel.innerHTML = '<option value="">(Error Kamera)</option>';
        document.getElementById('startBtn').disabled = true;
    }
}

/**
 * Meminta izin kamera dari browser.
 */
async function checkPermission() {
    try {
        // Mencoba mendapatkan stream video untuk meminta izin
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        
        // Hentikan stream setelah mendapatkan izin agar lampu indikator mati
        stream.getTracks().forEach(track => track.stop()); 

        setStatus('Izin kamera diberikan', 'success');
        await listCameras(); // Muat ulang daftar kamera dan atur default
    } catch (e) {
        setStatus('Izin kamera ditolak. Beri izin di pengaturan browser Anda.', 'error');
        LOG('Izin kamera ditolak: ' + e.name, 'e');
    }
}

/* ================= INISIALISASI DAN EVENT LISTENERS ================= */

// Event Listeners untuk tombol kontrol
document.getElementById('permBtn').addEventListener('click', () => checkPermission());
document.getElementById('startBtn').addEventListener('click', () => startScanner(document.getElementById('cameraSelect').value));
document.getElementById('stopBtn').addEventListener('click', () => stopScanner());

// Event Listener untuk perubahan kamera: hentikan yang lama, mulai yang baru dengan ID yang dipilih
document.getElementById('cameraSelect').addEventListener('change', () => {
    const selectedDeviceId = document.getElementById('cameraSelect').value;
    if (isScanning) {
        stopScanner().then(() => {
            if (selectedDeviceId) {
                 startScanner(selectedDeviceId);
            }
        });
    }
});

// Fungsi yang dijalankan setelah library html5-qrcode berhasil dimuat
async function initAfterLib() {
    // Jalankan checkPermission secara otomatis setelah library dimuat
    // agar pengguna hanya perlu menekan "Start"
    await checkPermission(); 
}

// Inisialisasi: Coba muat library dari CDN, jika gagal, berikan opsi lokal
(async () => {
    try {
        await loadScript(CDNS[0]);
        setStatus('Library dimuat (CDN)', 'success');
        initAfterLib();
        attachLocalLoader();
    } catch (e) {
        setStatus('CDN gagal. Coba "Muat Library Lokal".', 'error');
        LOG('Gagal memuat CDN: ' + e, 'e');
        attachLocalLoader();
    }
})();
</script>
</body>
</html>