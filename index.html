<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SCC QR Scanner Simple</title>
<style>
body{font-family:Arial,sans-serif;background:#f4f6f8;padding:20px;display:flex;justify-content:center;}
.card{background:#fff;padding:20px;border-radius:12px;max-width:480px;width:100%;box-shadow:0 6px 15px rgba(0,0,0,0.1);}
h1{text-align:center;margin-bottom:15px;color:#222;}
.controls{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-bottom:12px;}
select,button{padding:10px;border-radius:8px;font-size:14px;}
button{border:none;background:#111;color:#fff;cursor:pointer;transition:0.2s;}
button:hover{background:#333;}
#reader{width:100%;height:260px;background:#000;border-radius:12px;margin-bottom:12px;position:relative;}
.status{margin-bottom:10px;font-size:14px;}
table{width:100%;border-collapse:collapse;margin-top:10px;}
table th, table td{border:1px solid #ccc;padding:6px;font-size:12px;}
.status-color-Order\ Received{background:#ccc;}
.status-color-Processing{background:#87ceeb;}
.status-color-Picked\ Up{background:#ffd700;}
.status-color-In\ Transit{background:#ff8c00;}
.status-color-Delivered{background:#32cd32;}
.status-color-Completed{background:#9370db;}
</style>

<!-- Html5 QR Code CDN -->
<script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
</head>
<body>
<div class="card">
<h1>SCC QR Scanner</h1>

<div class="controls">
<label>Aksi:<br>
<select id="action">
<option>Order Received</option>
<option>Processing</option>
<option>Picked Up</option>
<option>In Transit</option>
<option>Delivered</option>
<option>Completed</option>
</select>
</label>

<label>Kamera:<br>
<select id="cameraSelect"><option>-- memuat --</option></select>
</label>
</div>

<div id="reader"></div>
<div id="status" class="status">Menunggu scanner...</div>

<label>Server endpoint:</label>
<input id="endpoint" value="https://script.google.com/macros/s/AKfycbwRSTGLtEI54Y5HxiZlDqSQbcO8VITtAj7susY-H6GWY3GOJubwEkDWNfpp4IOGzsoO/exec" style="width:100%;padding:8px;border-radius:6px;margin-bottom:10px;">

<table id="scanTable">
<thead>
<tr><th>QR Code</th><th>Status</th><th>Time</th></tr>
</thead>
<tbody></tbody>
</table>
</div>

<script>
let scanner=null,isScanning=false,recentScans=new Map();
const tableBody=document.querySelector('#scanTable tbody');
const DEDUPE_MS=5000;

function addRow(qr,status){
  const tr=document.createElement('tr');
  tr.className='status-color-'+status.replace(' ','\\ ');
  tr.innerHTML=`<td>${qr}</td><td>${status}</td><td>${new Date().toLocaleTimeString()}</td>`;
  tableBody.prepend(tr);
}

function dedupe(code){
  const now=Date.now();
  const last=recentScans.get(code)||0;
  if(now-last<DEDUPE_MS)return true;
  recentScans.set(code,now);
  for(const [k,t] of recentScans){if(now-t>60000)recentScans.delete(k);}
  return false;
}

function queueSend(decoded){
  const action=document.getElementById('action').value;
  addRow(decoded,action);
  const payload={qr:decoded,action,ts:new Date().toISOString()};
  fetch(document.getElementById('endpoint').value,{
    method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)
  }).then(r=>console.log('Sent:',decoded)).catch(e=>console.error('Send failed:',e));
}

function flashSuccess(){
  const r=document.getElementById('reader'); r.style.background='#0f0';
  setTimeout(()=>{r.style.background='#000';},200);
  const beep=new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA=');
  beep.play();
}

async function startScanner(deviceId=null){
  if(!window.Html5Qrcode){console.error('Html5Qrcode missing');return;}
  if(scanner){await scanner.stop();scanner.clear();}
  scanner=new Html5Qrcode("reader");
  const cfg=deviceId?{deviceId:{exact:deviceId}}:{facingMode:"environment"};
  scanner.start(cfg,{fps:10,qrbox:250},
    (decoded)=>{if(!dedupe(decoded)){queueSend(decoded);flashSuccess();}},
    (err)=>{}
  ).then(()=>{document.getElementById('status').textContent='Scanner running';isScanning=true;})
  .catch(err=>{document.getElementById('status').textContent='Camera error: '+err;console.error(err);});
}

async function listCameras(){
  const select=document.getElementById('cameraSelect');select.innerHTML='<option>memuat...</option>';
  try{
    const cams=await Html5Qrcode.getCameras();
    select.innerHTML='';
    cams.forEach((c,i)=>{const o=document.createElement('option');o.value=c.id;o.textContent=c.label||`Camera ${i+1}`;select.appendChild(o);});
    if(cams[0])startScanner(cams[0].id);
  }catch(e){console.error('Camera list failed:',e);select.innerHTML='<option>(error)</option>';}
}

document.addEventListener('DOMContentLoaded',()=>{listCameras();});
document.getElementById('cameraSelect').addEventListener('change',()=>{if(isScanning){scanner.stop().then(()=>startScanner(document.getElementById('cameraSelect').value));}});
</script>
</body>
</html>
