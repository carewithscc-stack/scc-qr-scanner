<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>SCC QR Scanner</title>
<style>
    body { font-family: Arial, sans-serif; background:#111; color:white; padding:20px; }
    button { padding:12px; margin:8px 0; font-size:16px; cursor:pointer; }
    #reader { width:100%; max-width:400px; margin-top:20px; }
    #log { margin-top:20px; white-space:pre-wrap; background:#222; padding:10px; }
</style>
</head>

<body>

<h2>SCC QR Scanner</h2>

<button id="loadLocalJsBtn">Load Local JS</button>
<input type="file" id="localJsFile" accept=".js" style="display:none">

<br><br>

<button id="startCameraBtn" disabled>Start Camera</button>
<select id="cameraList"></select>

<div id="reader"></div>

<div id="log">Log...</div>

<script>
let html5QrLoaded = false;
let html5QrInstance = null;
let scanning = false;
let lastScan = "";

function log(msg) {
    document.getElementById("log").textContent += "\n" + msg;
}

document.getElementById("loadLocalJsBtn").onclick = () => {
    document.getElementById("localJsFile").click();
};

document.getElementById("localJsFile").onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(ev) {
        const script = document.createElement("script");
        script.textContent = ev.target.result;
        document.body.appendChild(script);
        html5QrLoaded = true;
        log("Local Html5Qrcode loaded.");
        document.getElementById("startCameraBtn").disabled = false;
    };
    reader.readAsText(file);
};

document.getElementById("startCameraBtn").onclick = async () => {
    if (!html5QrLoaded) {
        alert("Load Html5Qrcode JS dulu.");
        return;
    }

    if (!html5QrInstance) {
        html5QrInstance = new Html5Qrcode("reader");
    }

    const devices = await Html5Qrcode.getCameras();
    const list = document.getElementById("cameraList");
    list.innerHTML = "";

    devices.forEach((cam) => {
        const opt = document.createElement("option");
        opt.value = cam.id;
        opt.textContent = cam.label;
        list.appendChild(opt);
    });

    const camId = list.value;

    html5QrInstance.start(
        camId,
        { fps: 10, qrbox: 250 },
        onScanSuccess
    )
    .then(() => {
        scanning = true;
        log("Camera started.");
    })
    .catch(err => log("Camera error: " + err));
};

async function onScanSuccess(decodedText) {
    if (decodedText === lastScan) return;
    lastScan = decodedText;

    log("SCAN OK: " + decodedText);

    await fetch(
        "https://script.google.com/macros/s/AKfycbyJvluaqqe3J_suB8RBWMptb51Iw7msr3R1KDB204w0XoBaZwlcahDZzJKaY90fiBcw/exec",
        {
            method: "POST",
            headers: { "Content-Type":"application/json" },
            body: JSON.stringify({ qr: decodedText })
        }
    ).catch(err => log("POST ERROR: " + err));
}
</script>

</body>
</html>